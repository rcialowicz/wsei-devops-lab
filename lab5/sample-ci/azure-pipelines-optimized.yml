# Azure Pipelines CI - OPTIMIZED VERSION
# Ten pipeline pokazuje najlepsze praktyki optymalizacji CI/CD

trigger:
  branches:
    include:
    - main

pool:
  vmImage: 'ubuntu-latest'

# Pojedynczy etap z sekwencyjnymi jobami (wym√≥g Azure Pipelines free tier)
stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  # Backend .NET - wszystko w jednym jobie
  - job: Backend
    displayName: 'Backend (.NET)'
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
    
    # Cache dla NuGet packages
    - task: Cache@2
      displayName: 'Cache NuGet packages'
      inputs:
        key: 'nuget | "$(Agent.OS)" | lab5/sample-ci/backend/**/packages.lock.json,lab5/sample-ci/backend/**/*.csproj'
        path: $(Pipeline.Workspace)/.nuget/packages
        restoreKeys: |
          nuget | "$(Agent.OS)"
    
    # Restore raz
    - script: |
        cd lab5/sample-ci/backend
        dotnet restore
      displayName: 'Restore dependencies'
    
    # Build raz (z --no-restore)
    - script: |
        cd lab5/sample-ci/backend
        dotnet build --configuration Release --no-restore
      displayName: 'Build application'
    
    # Test (z --no-build i --no-restore)
    - script: |
        cd lab5/sample-ci/backend
        dotnet test ProductApi.Tests/ProductApi.Tests.csproj \
          --configuration Release \
          --no-build \
          --no-restore \
          --logger trx
      displayName: 'Run unit tests'
    
    - task: PublishTestResults@2
      displayName: 'Publish test results'
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/TestResults/*.trx'
    
    # Publish (z --no-build)
    - script: |
        cd lab5/sample-ci/backend
        dotnet publish --configuration Release --no-build --output $(Build.ArtifactStagingDirectory)/backend
      displayName: 'Publish artifacts'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Upload artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend'
        ArtifactName: 'backend'

  # Frontend Node.js - wszystko w jednym jobie, sekwencyjnie po Backend
  - job: Frontend
    displayName: 'Frontend (Node.js)'
    dependsOn: Backend
    steps:
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '20.x'
    
    # Cache dla node_modules
    - task: Cache@2
      displayName: 'Cache node_modules'
      inputs:
        key: 'npm | "$(Agent.OS)" | lab5/sample-ci/frontend/package-lock.json'
        path: lab5/sample-ci/frontend/node_modules
        restoreKeys: |
          npm | "$(Agent.OS)"
    
    # Install raz
    - script: |
        cd lab5/sample-ci/frontend
        npm ci
      displayName: 'Install dependencies'
    
    # Test
    - script: |
        cd lab5/sample-ci/frontend
        npm test
      displayName: 'Run tests'
    
    # Build
    - script: |
        cd lab5/sample-ci/frontend
        npm run build
      displayName: 'Build frontend'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Upload artifacts'
      inputs:
        PathtoPublish: 'lab5/sample-ci/frontend/dist'
        ArtifactName: 'frontend'
