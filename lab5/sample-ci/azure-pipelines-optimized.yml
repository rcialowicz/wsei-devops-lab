trigger:
  branches:
    include:
    - main

pool:
  name: 'Default'  # Self-hosted agent (MS-hosted wymaga approval dla free tier)

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: Backend
    displayName: 'Backend (.NET)'
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
    
    - task: Cache@2
      displayName: 'Cache NuGet packages'
      inputs:
        key: 'nuget | "$(Agent.OS)" | lab5/sample-ci/backend/**/packages.lock.json,lab5/sample-ci/backend/**/*.csproj'
        path: $(Pipeline.Workspace)/.nuget/packages
        restoreKeys: |
          nuget | "$(Agent.OS)"
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet restore
      displayName: 'Restore dependencies'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet build --configuration Release --no-restore
      displayName: 'Build application'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet test ProductApi.Tests/ProductApi.Tests.csproj \
          --configuration Release \
          --no-build \
          --no-restore \
          --logger trx
      displayName: 'Run unit tests'
    
    - task: PublishTestResults@2
      displayName: 'Publish test results'
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/TestResults/*.trx'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet publish --configuration Release --no-build --output $(Build.ArtifactStagingDirectory)/backend
      displayName: 'Publish artifacts'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Upload artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend'
        ArtifactName: 'backend'

  - job: Frontend
    displayName: 'Frontend (Node.js)'
    dependsOn: Backend
    steps:
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '20.x'
    
    - task: Cache@2
      displayName: 'Cache node_modules'
      inputs:
        key: 'npm | "$(Agent.OS)" | lab5/sample-ci/frontend/package-lock.json'
        path: lab5/sample-ci/frontend/node_modules
        restoreKeys: |
          npm | "$(Agent.OS)"
    
    - script: |
        cd lab5/sample-ci/frontend
        npm ci
      displayName: 'Install dependencies'
    
    - script: |
        cd lab5/sample-ci/frontend
        npm test
      displayName: 'Run tests'
    
    - script: |
        cd lab5/sample-ci/frontend
        npm run build
      displayName: 'Build frontend'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Upload artifacts'
      inputs:
        PathtoPublish: 'lab5/sample-ci/frontend/dist'
        ArtifactName: 'frontend'
