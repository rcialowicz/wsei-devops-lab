trigger:
  branches:
    include:
    - main

pool:
  name: 'Default'  # Self-hosted agent (MS-hosted wymaga approval dla free tier)

stages:
- stage: BackendBuild
  displayName: 'Backend Build'
  jobs:
  - job: DotNetRestore
    displayName: 'Restore .NET dependencies'
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet restore
      displayName: 'Restore dependencies'
  
  - job: DotNetBuild
    displayName: 'Build .NET application'
    dependsOn: DotNetRestore
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet restore
      displayName: 'Restore dependencies again'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet build --configuration Release
      displayName: 'Build application'
  
  - job: DotNetTest
    displayName: 'Test .NET application'
    dependsOn: DotNetBuild
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet restore
        dotnet build --configuration Release
      displayName: 'Restore and build again'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet test ProductApi.Tests/ProductApi.Tests.csproj \
          --configuration Release \
          --logger trx
      displayName: 'Run unit tests'
    
    - task: PublishTestResults@2
      displayName: 'Publish test results'
      condition: always()
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/TestResults/*.trx'
  
  - job: DotNetPublish
    displayName: 'Publish .NET artifacts'
    dependsOn: DotNetTest
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet restore
        dotnet build --configuration Release
      displayName: 'Restore and build once more'
    
    - script: |
        cd lab5/sample-ci/backend
        dotnet publish --configuration Release --output $(Build.ArtifactStagingDirectory)/backend
      displayName: 'Publish artifacts'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Upload artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend'
        ArtifactName: 'backend'

- stage: FrontendBuild
  displayName: 'Frontend Build'
  dependsOn: BackendBuild  # Sequential (wym√≥g Azure Pipelines free tier)
  jobs:
  - job: NpmInstall
    displayName: 'Install npm packages'
    steps:
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '20.x'
    
    - script: |
        cd lab5/sample-ci/frontend
        npm install
      displayName: 'npm install'
  
  - job: NpmTest
    displayName: 'Run npm tests'
    dependsOn: NpmInstall
    steps:
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '20.x'
    
    - script: |
        cd lab5/sample-ci/frontend
        npm install
      displayName: 'npm install again'
    
    - script: |
        cd lab5/sample-ci/frontend
        npm test
      displayName: 'Run tests'
  
  - job: NpmBuild
    displayName: 'Build frontend'
    dependsOn: NpmTest
    steps:
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '20.x'
    
    - script: |
        cd lab5/sample-ci/frontend
        npm install
      displayName: 'npm install one more time'
    
    - script: |
        cd lab5/sample-ci/frontend
        npm run build
      displayName: 'Build frontend'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Upload artifacts'
      inputs:
        PathtoPublish: 'lab5/sample-ci/frontend/dist'
        ArtifactName: 'frontend'
